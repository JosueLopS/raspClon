"use strict";

const gpio = require("../gpio");

const COUNTER_PIN = 21;
const DEBOUNCE_US = 1000; // us
const SCAN_TIME_MS = 50; // ms
const COUNTER_HIGH = 20;

// init pins 
// counter counts on each connection to gound
gpio.init_gpio(COUNTER_PIN, gpio.GPIO_MODE_COUNTER_PULLUP, DEBOUNCE_US);

var cdir = gpio.C_UP;
var counter;
var counter_pre;

// start up counter
gpio.set_counter(COUNTER_PIN, COUNTER_HIGH, cdir);

// start scan loop
// count up from 0 to COUNTER_HIGH and down from COUNTER_HIGH to 0 
var loop_id = setInterval(() => {
    counter = gpio.get_counter(COUNTER_PIN);

    // check if counter changes
    if (counter !== counter_pre) {
        counter_pre = counter;
        console.log("counter: ", counter);
    }

    // switch counter direction on limit
    if (gpio.is_counter_onlimit(COUNTER_PIN)) {
        console.log("Counter on limit ", counter);
        cdir = (cdir == gpio.C_UP) ? gpio.C_DOWN : gpio.C_UP;
        gpio.set_counter(COUNTER_PIN, COUNTER_HIGH, cdir);
    }
}, SCAN_TIME_MS);

console.log("*** counter 1 example ***");
console.log("counts if pin", COUNTER_PIN, "is connected to ground");
console.log("stop program with Ctrl+C");

// handle Ctrl+C
process.on('SIGINT', () => {
    clearInterval(loop_id);
    gpio.deinit_gpio(COUNTER_PIN);
    console.log(" -> program stopped");
    process.exit();
});