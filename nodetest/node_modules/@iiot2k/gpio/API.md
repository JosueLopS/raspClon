# API @iiot2k/gpio

Raspberry Pi gpio library.

The @iiot2k/gpio driver uses the gpio character devices interface from the Linux operating system.<br>
The driver is loaded on call with ```require("@iiot2k/gpio");```<br>
On 64bit OS the driver ***gpio_arm64.node*** is loaded.<br>
On 32bit OS the driver ***gpio_arm32.node*** is loaded.<br>
If driver is unloaded function ```deinit_gpio``` is called for all pins.<br>

## pin Parameter
The Raspberry Pi has gpio pins from GPIO2 to GPIO27.<br>
Valid ```pin``` parameter values are 2..27.<br>

## mode Parameter
Each gpio pin can be assigned a function.<br>
The following table shows the different modes with ```mode``` parameter.<br>

|Constant|State-0|State-1|function|
|:--|:--|:--|:--|
|GPIO_MODE_INPUT_NOPULL|ground|+3.3V|floating input|
|GPIO_MODE_INPUT_PULLDOWN|open/ground|+3.3V|pulldown resistor input|
|GPIO_MODE_INPUT_PULLUP|open/+3.3V|ground|pullup resistor input|
|GPIO_MODE_OUTPUT|ground|+3.3V|output|
|GPIO_MODE_OUTPUT_SOURCE|Hi-Z|+3.3V|output source|
|GPIO_MODE_OUTPUT_SINK|Hi-Z|ground|output sink|
|GPIO_MODE_PWM|ground|+3.3V|pwm output pulse|
|GPIO_MODE_PWM_REALTIME|ground|+3.3V|pwm output pulse in realtime|
|GPIO_MODE_COUNTER_NOPULL|ground|+3.3V|floating input counter|
|GPIO_MODE_COUNTER_PULLDOWN|open/ground|+3.3V|pulldown resistor input counter|
|GPIO_MODE_COUNTER_PULLUP|open/+3.3V|ground|pullup resistor input counter|
|GPIO_MODE_SENSOR|ground|Hi-Z|output sink|

Floating input/output is used when the pin is connected to another pin.<br>
Input voltages more than +3.3V can destroy the input.<br>
Hi-Z refers to an output signal state in which the signal is not being driven.<br>
Please do not init gpio pins with special functions (i2c, spi, uart..).<br>

<div class="page"/>

## Initialization functions

> ### Initializes the gpio with the mode.<br>
```init_gpio(pin, mode, setval)```<br>
***pin:*** ```<integer>``` 2..27<br>
***mode:*** ```<integer>``` GPIO_MODE_...<br>
***setval:*** ```<integer>``` or ```<boolean>```<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
The ***setval*** parameter sets the **debounce time** in us for inputs,<br>
and can set to 0 for disable debounce.<br>
For outputs ***setval*** parameter sets initial state (0/1) of ```true/false```. <br>
If pin set to watch, false is returned.

> ### Changes the mode of gpio.<br>
```change_gpio(pin, mode, setval)```<br>
***pin:*** ```<integer>``` 2..27<br>
***mode:*** ```<integer>``` GPIO_MODE_...<br>
***setval:*** ```<integer>``` or ```<boolean>```<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
The pin must be initialized with **init_gpio()**.<br>
The ***setval*** parameter sets the **debounce time** in us for inputs,<br>
and can set to 0 for disable debounce.<br>
For outputs ***setval*** parameter sets initial state (0/1) of ```true/false```.<br>
Only mode of inputs and outputs can be changed.<br>
If pin set to watch, false is returned.

<div class="page"/>

## Watch functions

## edge Parameter
The ```edge``` parameter sets the watch direction of inputs.<br>
|Constant|Value|Function|
|:--|:--|:--|
|GPIO_EDGE_RISING|0|check for change from 0 to 1|
|GPIO_EDGE_FALLING|1|check for change from 1 to 0|
|GPIO_EDGE_BOTH|2|check for change from 0 to 1 or 1 to 0|

> ### Watch the gpio input for changes.<br>
```watch_gpio(pin, mode, debounce, edge, callback)```<br>
***pin:*** ```<integer>``` 2..27<br>
***mode:*** ```<integer>``` GPIO_MODE_INPUT...<br>
***debounce:*** ```<integer>``` 0..<br>
***edge:*** ```<integer>``` GPIO_EDGE_...<br>
***callback:*** ```<function>```
- (state, edge)<br> 
    state ```<integer>``` 0/1,<br> 
    edge ```<integer>```GPIO_EDGE_RISING or GPIO_EDGE_FALLING.<br> 

***return:*** ```<number>``` ```0/1``` actual input state, ```undefined``` on error.<br>

The ***debounce*** parameter sets the **debounce time** in us for inputs,<br>
and can set to 0 for disable debounce.<br>
The ***callback*** function is called if input state changes.<br>
If pin set to watch, ```undefined``` is returned.

> ### Deinitializes the gpio and releases all resources.<br>
```deinit_gpio(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
Stops also pwm and counter engine.<br>
If pin set to watch, watch engine ist stopped.<br>

<div class="page"/>

## Input/Output functions

> ### Gets gpio state as boolean.<br>
```get_gpio(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```false/true```, ```undefined``` on error.<br>
The pin must be initialized as input or output.<br>

> ### Gets gpio state as number.<br>
```get_gpio_num(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<integer>``` 0/1, ```undefined``` on error.<br>
The pin must be initialized as input or output.<br>

> ### Sets gpio state of output.<br>
```set_gpio(pin, value)```<br>
***pin:*** ```<integer>``` 2..27<br>
***value:*** ```<integer>``` 0/1 or ```<boolean>``` ```true/false```<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
The pin must be initialized as output.<br>

> ### Toggle gpio state of output.<br>
```toggle_gpio(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
The pin must be initialized as output.<br>

<div class="page"/>

## Pulse Wide Modulation (PWM) Functions
Pulse Wide Modulation pulse is generated on output.<br>
PWM can be used for example to adjust the brightness of LEDs.<br>
Because PWM is generated with software, the accuracy of dutycycle is accurate up to approximately 800Hz.<br>
For better accuracy use mode **GPIO_MODE_PWM_REALTIME**.<br>
In **GPIO_MODE_PWM_REALTIME** mode the CPU load is higher.<br>
The on+off time is 1/frequency (e.g. 1/100Hz = 10ms).<br>
Dutycycle means the % time for on.<br>
For example dutycycle 75% on 100Hz is 7.5ms on and 2.5ms off time.<br>
A dutycycle of 0% turns output off.<br>
A dutycycle of 100% turns output on.<br>
The pin must be initialized as pwm (GPIO_MODE_PWM or GPIO_MODE_PWM_REALTIME).<br>

> ### Sets pwm frequency and dutycycle.<br>
```set_pwm(pin, frequency_hz, dutycycle)```<br>
***pin:*** ```<integer>``` 2..27<br>
***frequency_hz:*** ```<integer>``` 2..45000 (Hz)<br>
***dutycycle:*** ```<integer>``` 0..100 (%)<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
Starts pwm engine if not startet.<br>

> ### Gets pwm frequency.<br> 
```get_pwm_frequency(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<integer>``` 2..45000 (Hz), ```undefined``` on error.<br>

> ### Gets pwm dutycycle.<br> 
```get_pwm_dutycycle(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** 0..100 (%), ```undefined``` on error.<br>

<div class="page"/>

## High Speed Counter Functions
Implements high speed software counter.<br>
Counts on each change of input state from 0 to 1.<br>
The pin must be initialized as counter (GPIO_MODE_COUNTER_..)<br>

## cnt_mode Parameter
The ```cnt_mode``` parameter sets the count direction of counter.<br>
|Constant|Value|Function|
|:--|:--|:--|
|C_UP|0|counts up to ```counter_high```|
|C_DOWN|1|counts down to zero|

> ### Sets counter hardware reset pin.<br>
```set_counter_reset_pin(pin, pin_reset)```<br>
***pin:*** ```<integer>``` 2..27<br>
***pin_reset:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
Sets counter hardware reset pin.<br>
```pin_reset``` must init to input (GPIO_MODE_INPUT_..) before call ```set_counter```.<br>
If ```pin_reset``` changes input state from 0 to 1, the counter is reset.<br>

> ### Sets counter hardware output pin.<br>
```set_counter_output_pin(pin, pin_output)```<br>
***pin:*** ```<integer>``` 2..27<br>
***pin_output:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
Sets counter hardware output pin.<br>
```pin_output``` must init to output (GPIO_MODE_OUTPUT_..) before call ```set_counter```.<br>
```pin_output``` state is equal call of ```is_counter_onlimit```.<br>

> ### Sets counter.<br>
```set_counter(pin, counter_high, cnt_mode)```<br>
***pin:*** ```<integer>``` 2..27<br>
***counter_high:*** ```<integer>``` 1..4294967294<br>
***cnt_mode:*** ```<integer>``` **C_UP**, **C_DOWN**<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
Starts counter engine if not startet.<br>
Resets also counter (see reset_counter).<br>

<div class="page"/>

> ### Resets counter.<br>
```reset_counter(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>
cnt_mode = **C_UP**: counter is set to 0.<br>
cnt_mode = **C_DOWN**: counter is set to ```counter_high```.<br>

> ### Gets counter value.<br>
```get_counter(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<integer>``` counter value (0..4294967294), ```undefined``` on error<br>

> ### Gets counter_high value.<br>
```get_counter_high(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<integer>``` ```counter_high``` value (1..4294967294), ```undefined``` on error<br>

> ### Gets counter mode.<br>
```get_counter_mode(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return :*** ```<integer>``` **C_UP**, **C_DOWN**, ```undefined``` on error<br>

> ### Check if counter is on limits.<br>
```is_counter_onlimit(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return :*** ```<boolean>``` ```true/false```, ```undefined``` on error<br>
cnt_mode = **C_UP**: returns ```true``` when counter is equal ***counter_high***.<br>
cnt_mode = **C_DOWN**: returns ```true``` when counter is equal 0.<br>

<div class="page"/>

## Temperature Sensors with 1-wire protocol
The functions reads the DS18B20 temperature.<br>
You can connect multiple sensors in parallel.<br>
It is important that a 4.7k pullup resistor is connected.<br>
The library does not support the parasite mode.<br>
Please do not activate the 1-wire subsystem of the raspberry pi.<br>
For high-performance reading, all sensors must have set to the same resolution.<br>
The pin must be initialized as GPIO_MODE_SENSOR.<br>

## res Parameter
The ```res``` (resolution) parameter sets the resolution of ds18b20 sensors.<br>
|Constant|Value|Resolution|Conversion Time|Temp. Steps|
|:--|:--|:--|:--|:--|
|RES_SENSOR_9|0|9 bit|94ms|0.5°|
|RES_SENSOR_10|1|10 bit|187ms|0.25°|
|RES_SENSOR_11|2|11 bit|375ms|0.125°|
|RES_SENSOR_12|3|12 bit|750ms|0.0625°|

> ### Init all sensors to resolution.<br>

```init_sensor(pin, res)```<br>
***pin:*** ```<integer>``` 2..27<br>
***res:*** ```<integer>``` RES_SENSOR_..<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>

> ### Scans all sensors.<br>

```scan_sensor(pin, callback)```<br>
***pin:*** ```<integer>``` 2..27<br>
***callback:*** ```<function>```<br> 
```(ret)``` ```<boolean>``` ```true``` on ok, ```false``` on error.<br>

```scan_sensor_sync(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<boolean>``` ```true``` on ok, ```false``` on error.<br>

> ### List all sensors.<br>

```list_sensor(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<string array>``` list of sensors id in format 28-HHHHHHHHHHHH (hex), ```undefined``` on error.<br> 

<div class="page"/>

> ### Get sensor count.<br>

```get_sensor_count(pin)```<br>
***pin:*** ```<integer>``` 2..27<br>
***return:*** ```<integer>``` number of sensors, ```undefined``` on error.<br> 

> ### Read all sensors.<br>

```read_sensor(pin, fh, callback)```<br>
***pin:*** ```<integer>``` 2..27<br>
***fh:*** ```<boolean>``` ```false:``` output is celsius, ```true:``` output is fahrenheit.<br>
***callback:*** ```<function>```<br> 
```(data)``` ```<number array>``` temperature of sensors, ```undefined``` on error.<br>


```read_sensor_sync(pin, fh)```<br>
***pin:*** ```<integer>``` 2..27<br>
***fh:*** ```<boolean>``` ```false:``` output is celsius, ```true:``` output is fahrenheit.<br>
***return:*** ```<number array>``` temperature of sensors, ```undefined``` on error.<br> 

> ### Read one sensor.<br>

```read_one_sensor_promise(pin, id, fh, callback)```<br>
***pin:*** ```<integer>``` 2..27<br>
***id:*** ```<string>``` id of sensor in format 28-HHHHHHHHHHHH (hex).<br>
***fh:*** ```<boolean>``` ```false:``` output is celsius, ```true:``` output is fahrenheit.<br>
***callback:*** ```<function>```<br> 
```(data)``` ```<number>``` temperature of sensor, ```undefined``` on error or no sensors.<br>

```read_one_sensor_sync(pin, id, fh)```<br>
***pin:*** ```<integer>``` 2..27<br>
***id:*** ```<string>``` id of sensor in format 28-HHHHHHHHHHHH (hex).<br>
***fh:*** ```<boolean>``` ```false:``` output is celsius, ```true:``` output is fahrenheit.<br>
***return:*** ```<number>``` temperature of sensor, ```undefined``` on error or no sensors. 



