"use strict";

const gpio = require("../gpio");

const INPUT_PIN = 21;
const PWM_PIN = 20;
const DEBOUNCE_US = 1000; // us
const SCAN_TIME_MS = 50; // ms
const PWM_FREQ = 200; // Hz
const PWM_DUTYC_1 = 75; // %
const PWM_DUTYC_2 = 25; // %

// init pins 
// input must connect to ground for switch pwm
gpio.init_gpio(INPUT_PIN, gpio.GPIO_MODE_INPUT_PULLUP, DEBOUNCE_US);
gpio.init_gpio(PWM_PIN, gpio.GPIO_MODE_PWM, 0);

// start scan loop
// switch pwm with input
var loop_id = setInterval(() => {
    if (!gpio.get_gpio(INPUT_PIN))
        gpio.set_pwm(PWM_PIN, PWM_FREQ, PWM_DUTYC_1);
    else
        gpio.set_pwm(PWM_PIN, PWM_FREQ, PWM_DUTYC_2);
}, SCAN_TIME_MS);

console.log("*** pwm example ***");
console.log("pwm output is pin", PWM_PIN);
console.log("input pin", INPUT_PIN, "switches duty cycle when connected to ground");
console.log("stop program with Ctrl+C");

// handle Ctrl+C
process.on('SIGINT', () => {
    clearInterval(loop_id);
    gpio.deinit_gpio(INPUT_PIN);
    gpio.deinit_gpio(PWM_PIN);
    console.log(" -> program stopped");
    process.exit();
});